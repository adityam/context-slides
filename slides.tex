\startenvironment *

\definefontfeature
  [default]
  [default]
  [compose=yes, expansion=quality, protrusion=quality]

\definefontfamily [mainface] [rm] [Fontin]
\definefontfamily [mainface] [ss] [Delicious]
\definefontfamily [mainface] [tt] [Dejavu Mono Sans] [scale=0.85, features=none]
\definefontfamily [mainface] [mm] [Neo Euler]

\setupbodyfont[mainface, 12pt]

\setupalign[hanging]
\setupwhitespace[fixed,big]
\setupblank[fixed]
\setupalign[nothyphenated]
\setuptolerance[verystrict]

\setuppapersize [S5]

\setuplayout
    [
      cutspace=3mm,
      leftmargin=2mm,
      leftmargindistance=1mm,
      width=middle,
      rightmargindistance=1mm,
      rightmargin=2mm,
      backspace=3mm,
      %
      topspace=2mm,
      header=0mm,
      headerdistance=0mm,
      height=middle,
      footerdistance=0.2\lineheight,
      footer=0.8\lineheight,
      bottomspace=1mm,
    ]


\startreusableMPgraphic {page:background}
  StartPage;
    save p; path p;
    % p := Page superellipsed 0.98;
    p := Page cornered (PaperWidth/15);
    fill Page withcolor darkred;
    fill p withcolor lightgray;
  StopPage;
\stopreusableMPgraphic

\defineoverlay [page:background][\reuseMPgraphic{page:background}]

\setupbackgrounds[page][background={page:background}]

\usemodule[visualcounter]

\definevisualcounter
    [userpage]
    [countdown]
    [
      style=small,
      counter=userpage,
      palette=counter,
    ]

\definepalet
    [counter]
    [
      past=darkred,
      active=darkblue,
      future=darkgray,
    ]

\setupfooter[style=small,color=darkblue]
\setupfootertexts[\setups{footer:metadata}][\usevisualcounter{userpage}]

\startsetups footer:metadata
  \getvariable{metadata}{title:marking} (\getvariable{metadata}{author:marking})
\stopsetups

\definehead
    [slide]
    [subject]  
    [
      style=\ssbfc,
      interlinespace=10pt,
      color=darkred,
      alternative=middle,
      page=yes,
      before=,
      after=,
    ]


\setupitemize
    [
      headstyle=\ssa,
      headcolor=darkred,
      afterhead={\blank[none]},
      inbetween={\blank[2*big]},
    ]

\startuseMPgraphic{itemize:main}
  save p; path p;
  p := fullsquare scaled 1.5ExHeight;
  fill p withcolor \MPcolor{darkred};
\stopuseMPgraphic

\startuseMPgraphic{itemize:nested}
  save p; path p;
  p := ( (0,-0.5)--(0,0.5)--(0.866,0)--cycle ) scaled ExHeight;
  fill p withcolor \MPcolor{darkred};
\stopuseMPgraphic

\definesymbol[itemize:main][\useMPgraphic{itemize:main}]
\definesymbol[itemize:nested][\useMPgraphic{itemize:nested}]

\setupitemize[1][symbol=itemize:main]
\setupitemize[1][symbol=]
\setupitemize[2][symbol=itemize:nested, width=1.5ex]
\setupitemize[2][nowhite]

\unprotect
\c_strc_itemgroups_spacing_mode\plusone
\protect

\setvariables
    [metadata]
    [
      set={\setups{titlepage}},
    ]

\definestyle[titlestyle]   [style=\ssbfd, color=darkred]
\definestyle[subtitlestyle][style=\ssita, color=darkred]
\definestyle[authorstyle]  [style=\ssb,   color=darkblue]
\definestyle[datestyle]    [style=\tf,    color=]
\definestyle[locationstyle][style=\tf,    color=]

\startsetups titlepage
  \doifnothing{\getvariable{metadata}{title:marking}}
      {\setvariables[metadata][title:marking=\getvariable{metadata}{title}]}
  %
  \doifnothing{\getvariable{metadata}{author:marking}}
      {\setvariables[metadata][author:marking=\getvariable{metadata}{author}]}
  %
  \startstandardmakeup[align=middle]
    \titlestyle{\getvariable{metadata}{title}}
    \blank[medium]
    \subtitlestyle{\getvariable{metadata}{subtitle}}
    \blank[2*big]

    \authorstyle{\getvariable{metadata}{author}}
    \blank[big]
    \authorstyle{\switchtobodyfont[small]\getvariable{metadata}{affiliation}}
    \blank[big]

    \locationstyle{\getvariable{metadata}{location}}
    \blank[none]
    \datestyle{\getvariable{metadata}{date}}
  \stopstandardmakeup
\stopsetups

\setupformula
    [spacebefore={nowhite,quarterline}, spaceafter={back,nowhite,quarterline}]


\setupcaptions
    [
      number=no,
    ]

\setupfloats
    [
      spacebefore=nowhite,
      spaceafter=small,
    ]

\definemeasure[page][\dimexpr\pagegoal-\pagetotal-\lineheight\relax]
\definemeasure[shortpage][\dimexpr\pagegoal-\pagetotal-\lineheight-2\bigskipamount\relax]

\defineexternalfigure
    [horizontal]
    [
      width=\textwidth,
      height=\measure{page},
      factor=max,
    ]

\defineexternalfigure
    [vertical]
    [
      width=0.5\textwidth,
      height=\measure{shortpage},
      factor=max,
    ]

\defineexternalfigure
    [illustration]
    [
      width=0.25\textwidth,
      factor=fit,
    ]

\stopenvironment
